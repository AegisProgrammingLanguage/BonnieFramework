import "lib/bonnie.aeg"
import "packages/tera/tera.aeg"

class HomeController implements RequestHandler {
    public handle(req) {
        return render("templates/index.html", {
            name: "ikigami"
        })
    }
}

class ApiController implements RequestHandler {
    public handle(req) {
        return new Response("{ \"status\": \"ok\", \"engine\": \"Aegis\" }")
    }
}

class UserController implements RequestHandler {
    public handle(req) {
        var user = new User()
        var users = user.manager.all()
        return render("templates/users.html", {
            users: users
        })
    }
}

class User extends Model {
    init() {
        this.tablename = "users"
        this.manager = new Manager(this)
    }
}

func main() {
    var app = new Application()

    Settings.database = "db.sqlite3"
    Settings.db_conn = Sqlite.open(Settings.database)

    Sqlite.execute(Settings.db_conn, "CREATE TABLE IF NOT EXISTS users (id INTEGER PRIMARY KEY, username VARCHAR(255) NOT NULL);", null)

    app.use(new StaticMiddleware("/static", "static"))

    app.get("/", new HomeController())
    app.get("/api", new ApiController())
    app.get("/users", new UserController())

    app.run("127.0.0.1", 9000)

    Sqlite.close(Settings.db_conn)
}

main()
